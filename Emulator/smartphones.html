<!DOCTYPE html>
<html>
<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Smartphone Emulator</title>

	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">
	<link href="https://fonts.googleapis.com/css?family=Dosis" rel="stylesheet">
	<link rel="stylesheet" href="switch.css">
	<script src="/socket.io/socket.io.js"></script>
	<script src="https://code.jquery.com/jquery-3.1.1.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

	<!--[if lt IE 9]>
	  <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.2/html5shiv.js"></script>
	  <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
	<![endif]-->

	<script type="text/javascript">
		var socket = io();
		let students;
		$(document).ready(function() {
			socket.on('question', json => {
				confirmId(function() {
					$("#sendBtn").attr('disabled', false);
					htmlQuestion(json);
				}, function() {
					if (!$("#mimicQuizBoxAnswer").hasClass('hide'))
						$("#mimicQuizBox").addClass('hide'); 
				});
			});
			socket.on('everyoneConnected', bool => {
				everyoneConnected(bool);
			});
			socket.on('quizIsFinished', (bool, json) => {
				console.log('quiz is finished!');
				let deviceId = $("#kbdDeviceId").text();
				console.log(deviceId);      
				console.log('id is confirmed! Time to show score!');
				if (Object.keys(json['points']).indexOf(deviceId) !== -1) {
					let name = json['students'][$("#kbdNumber").text()];
					let nameArr = name.split(' ');
					let temp;
					if (nameArr[0].slice(-1) === 'a')
						temp = 'uzyskałaś';
					else
						temp = 'uzyskałeś';
					$("#afterMimicResultsName").html(`Gratulacje! ${temp}:<br>`);
					$("#afterMimicResultsScore").html(`${json['points'][deviceId]}%`);
					$("#mimicQuizBox").addClass('hide');
					$("#mimicWaitingForData").addClass('hide');
					$("#afterMimicResults").removeClass('hide');                  
				}
			});

			$.post('/smartphoneSetCookiesAndStudents', function (json) {
				students = json['students'];
				if(json['user'] !== undefined) {
					let user = JSON.parse(json['user']);
					if (user['username'] !== undefined && user['userclass'] !== undefined && user['usernumber'] !== undefined) {
						loadUser(user['username'], user['userclass'], user['usernumber']);
					}
					else {
						$("#chooseClass").removeClass("hide");
						updateSettings(['mimicMainApp', 'selfQuizingMode'], [false, false]);
					}
				}
				else {
					updateSettings(['mimicMainApp', 'selfQuizingMode'], [false, false]);
					$("#classList").empty();
					for(let key in students) {
						$("#classList").append("<option>" + key + "</option>");
					}
					$("#chooseClass").removeClass("hide");
				}
				$("#kbdDeviceId").html(json['userData']['deviceId']);
				$("#kbdIP").html(json['userData']['ip']);
				$("#kbdSoftware").html(json['userData']['software']);
			});
			$("#confirmClassList").click(function() {
				$("#studentsList").empty();
				for(let key in students[$("#classList").find(":selected").text()]) {
					$("#studentsList").append("<option>" + key + "</option>");
				}
			});
			$("#confirmStudentsList").click(function() {
				$("#imieNazwisko").text(students[$("#classList").find(":selected").text()][$("#studentsList").find(":selected").text()]);
				if ($("#studentsList").find(":selected").text() !== "N/A") {
					if ($("#confirmButton").is(":disabled"))
						$("#confirmButton").attr("disabled", false);
				}
			});
			$("#confirmButton").click(function() {
				let username = $("#imieNazwisko").text();
				let userclass = $("#classList").find(":selected").text();
				let usernumber = $("#studentsList").find(":selected").text();
				let json = {
					'name': username, 
					'class': userclass, 
					'number': usernumber
				};
				$.post("/smartphoneSetUser", json);
				loadUser(username, userclass, usernumber);
			});
			$("#sendBtn").click(function(e) {
				if (e.target.attributes['disabled'] === undefined) {
					let inputBox = $("#inputBox").text();
					if (parseInt(inputBox) >=1 && parseInt(inputBox)<=4) {
						$("#sendBtn").attr('disabled', true);
					}
					$.post("/smartphoneSendCode", {'code': inputBox});
				}
			});
			$(".authorizeBtn").click(function(e) {
				if (e.target.attributes['disabled'] === undefined) {
					$.post("/smartphoneSendCode", {'code': './' + $("#confirmedNumber").text()}, function (err) {
					  if (err) throw err;
					 });
					if (e.target.parentElement.id === 'mimicWrapper' && $('.waitingForData').hasClass('hide')) {
						$(".waitingForData").removeClass('hide');
					}                   
				}
			});
			$(".btn.sendable").click(function(e) {
				let value = e.target.attributes['value'].value;
				console.log($(this));
				console.log(value);
				let inputBox = $("#inputBox").text();
				switch (value) {
					case "C": {
						if (inputBox.length > 0) {
							$("#inputBox").text(inputBox.slice(0, -1));
						}
					}; break;
					default: {
						if (inputBox.length < 6) {
							inputBox += value;
							$("#inputBox").text(inputBox);
						}
					}; break;
				}
			});
			$(".userBtn").click(function() {
				$("#userModal").modal({backdrop: "static"});
			});
			$(".optionsBtn").click(function() {
				$("#optionsModal").modal({backdrop: "static"});
			});
			$("#deleteCookiesBtn").click(function() {
				$("#deleteCookiesBtn").addClass("hide");
				$("#deleteCookiesConfirmationBox").removeClass("hide");
			});
			$("#confirmDeletingCookies").click(function() {
				$.post("/smartphoneDeleteCookies", function() {
					location.reload(true);
				});
			});
			$(".declineDeletingCookies").click(function() {
				$("#deleteCookiesBtn").removeClass("hide");
				$("#deleteCookiesConfirmationBox").addClass("hide");
			});

			$(".settingsCheckbox").on("change", function(e) {
				let json = {
					bool: $(`input[name=${e.target.name}]`).is(":checked"),
					name: e.target.name
				};
				switch(json['name']) {
					case 'mimicMainApp': {
						if (json['bool']) {
							if ($('input[name=selfQuizingMode]').is(':checked')) {
								$(`div[name=selfQuizingMode`).click();
							}
							$("#remoteWrapper").addClass("hide");
							$("#selfQuizWrapper").addClass('hide');
							$("#mimicWrapper").removeClass("hide");
						}
						else if (!json['bool']) {
							$("#remoteWrapper").removeClass("hide");
							$("#mimicWrapper").addClass("hide");
							$("#selfQuizWrapper").addClass("hide");
						}
						updateSettings(['mimicMainApp', 'selfQuizingMode'], [$('input[name=mimicMainApp]').is(':checked'), $('input[name=selfQuizingMode]').is(':checked')]);
					}; break;
					case 'selfQuizingMode': {
						if (json['bool']) {
							if ($('input[name=mimicMainApp]').is(':checked')) {
								$(`div[name=mimicMainApp`).click();
							}
							$("#remoteWrapper").addClass("hide");
							$("#selfQuizWrapper").removeClass('hide');
							$("#mimicWrapper").addClass("hide");
						}
						else if (!json['bool']) {
							$("#remoteWrapper").removeClass('hide');
							$("#mimicWrapper").addClass("hide");
							$("#selfQuizWrapper").addClass("hide");
						}
						updateSettings(['mimicMainApp', 'selfQuizingMode'], [$('input[name=mimicMainApp]').is(':checked'), $('input[name=selfQuizingMode]').is(':checked')]);
					}; break;
				}
			});
			$("#reloadQuestionBtn").click(function() {
				reloadQuestion();
			});


			$(".mimicQuizBoxAnswer").click(function(e) {
				let code;
				if (e.target.className.indexOf('img-responsive') !== -1) {        
					code = e.target.parentElement.id.slice(-1);
				}
				else {
					code = e.target.id.slice(-1)
				}
				$("#mimicWaitingForData").removeClass('hide');
				$("#mimicQuizBox").addClass('hide');
				$.post("/smartphoneSendCode", {'code': code});
			});

			function loadUser(username, userclass, usernumber) {
				$("#chooseClass").addClass('hide');
				$("#confirmedYou, #kbdYou").text(username);
				$("#confirmedClass, #kbdClass").text(userclass);
				$("#confirmedNumber, #kbdNumber").text(usernumber);
				$("#remoteWrapper").removeClass("hide");
				$("#remoteWrapper").css('display', 'none');
				readSettings();
			};

			function confirmId(callbackTrue, callbackFalse) {
				$.post('/smartphoneConfirmId', json => {
					if (json.bool)
						callbackTrue(json.deviceId);
					else {
						if (callbackFalse !== undefined)
							callbackFalse(json.deviceId);
					}
				});
			}

			function htmlQuestion(json) {
				$("#idPytania").text(json['index']);
				$("#mimicQuizBoxQuestion").html(json['question'][0]);
				for(let i=1; i<5; i++) {
					if (!$(`#mimicQuizBoxAnswer${i}`).hasClass('mimicQuizBoxBorder')) {
						$(`#mimicQuizBoxAnswer${i}`).addClass('mimicQuizBoxBorder');
					}
					if (json['question'][i].indexOf('{i}') !== -1) {
						$(`#mimicQuizBoxAnswer${i}`).removeClass('mimicQuizBoxBorder');
					}
					json['question'][i] = json['question'][i].replace(/{i}/g, '<img class="img-responsive img-thumbnail" src="');
					json['question'][i] = json['question'][i].replace(/{I}/g, '">')
					$(`#mimicQuizBoxAnswer${i}`).html(json['question'][i]);
				}
				$("#mimicWaitingForData").addClass('hide');
				$("#mimicQuizBox").removeClass('hide');
			}

			function everyoneConnected(bool) {
				if (bool) {
					confirmId(function() {
						if (!$("#mimicWaitingForData").hasClass('hide')) {
							$("#mimicWaitingForData").addClass('hide');
						}
						$("#mimicWaitingForData").addClass('hide');
						$("#mimicQuizBox").removeClass('hide');
						$(".authorizeBtn").attr('disabled', true);
					});
				}
				else {
					$(".authorizeBtn").removeAttr('disabled');
					$(".authorizeBtn").prop('disabled', false);
					$(".authorizeBtn").attr('disabled', false);
					$("#mimicQuizBox").addClass('hide');
					$("#mimicWaitingForData").addClass('hide');
					$("#afterMimicResults").addClass('hide');
				}
			}

			function reloadQuestion() {
				$.post('/smartphoneReloadQuestion', function (json) {
					if (json !== undefined) {
						confirmId(function() {
							console.log(json);
							htmlQuestion(json);
							everyoneConnected(true); 
						});
					}
				});
			};

			function updateSettings(setting, value) {
				if (setting !== undefined && value !== undefined) {
					$.post('/smartphoneSetSettings', {setting: setting, value: value});
				}
			};

			function readSettings() {
				$.post('/smartphoneReadSettings', function (settings) {
					for(let key in settings) {
						let x = $(`input[name=${key}]`).is(':checked');
						let y = (settings[key] == 'true');
						// console.log(`${x} (${typeof(x)}) != ${y} (${typeof(y)}) \t| output: ${x != y}`);
						// console.log(`${x} (${typeof(x)}) !== ${y} (${typeof(y)}) \t| output: ${x !== y}`);
						if (x !== y)
							$(`div[name=${key}]`).click();
					}
					$('#remoteWrapper').css('display', 'block');
				});
			}
		});
	</script>

	<style>
		body {
			background-color: darkslategray;
			color: #fff;
			font-family: 'Dosis', sans-serif;
			outline: none !important;
		}
		#remoteWrapper, #mimicWrapper, #selfQuizWrapper {
			padding: 20px;
		}
		#inputBox {
			background-color: darkcyan;
			font-size: 24px;
			border-radius: 12px;
			border: 1px solid #000;
			min-height: 36px;
		}
		.btn {
			outline: none !important;
			border: 1px solid #000;
		}
		#chooseClass {
			width: 100vw;
			height: 100vh;
			display: flex;
			justify-content: center;
			align-items: center;
			font-size: 24px;
		}
		#wybierzSiebie {
			justify-content: center;
			align-items: center;
		}
		#classList, #studentsList {
			color: black;
		}
		#imieNazwisko {
			color: greenyellow;
		}
		.optionsFlex {
			display: flex;
			flex-direction: row;
			justify-content: flex-end;
			align-items: center;
		}
		.optionsFlex > span {
			margin-left: 15px;
			margin-bottom: 10px;
		}
		.confirmed {
			font-size: 1.5em;
			color: greenyellow;
		}
		.modal {
			color: #000;
		}
		.glyphicon {
			font-size: 20px;
		}
		.modal-body {
			font-size: 16px;
		}
		.switchDivFlex {
			display: flex;
			align-items: center;
			justify-content: space-between;
		}
		.switchDivFlex > span {
			font-size: 1.2em;
		}
		#mimicQuizBox {
			font-size: 20px;
		}
		.mimicQuizBoxBorder {
			border-radius: 4px;
			border: 1px solid #fff;
			padding: 4px;
		}
		.mimicQuizBoxAnswer {
			margin-bottom: 25px;
		}
		.btn-flex {
			display: flex;
			align-items: center;
			justify-content: space-between; 
		}
		#afterMimicResults {
			font-size: 20px;
		}
	 </style>
  </head>
<body>
	<div id="chooseClass" class="col-xs-12 text-center hide">
		<div id="wybierzSiebie">
			<div class="alert alert-info">
				Po wybraniu klasy lub numeru <strong>obowiązkowo</strong> wciśnij <span class="glyphicon glyphicon-ok"></span> by zatwierdzić wybór!
			</div>
			<h2>Wybierz swoją klase i swój numer z dziennika</h2><br>
			Klasa <select id="classList"><option>N/A</option></select> <span id="confirmClassList" class="glyphicon glyphicon-ok"></span> numer <select id="studentsList"><option>N/A</option></select> <span id="confirmStudentsList" class="glyphicon glyphicon-ok"></span><br>
			<div id="confirmBox">Czy <span id="imieNazwisko">N/A</span> to ty?<br><button id="confirmButton" type="button" class="btn btn-lg btn-success btn-block btn-flex" disabled>TAK <span class="glyphicon glyphicon-ok"></span></button></div>
		</div>
	</div>

	<div id="remoteWrapper" class="col-xs-12 text-center hide">
		<div class="optionsFlex"><span class="userBtn glyphicon glyphicon-user"></span><span class="optionsBtn glyphicon glyphicon-cog"></span></div>
		<div><span id="confirmedYou" class="confirmed">N/A</span>, klasa: <span id="confirmedClass" class="confirmed">N/A</span>, numer: <span id="confirmedNumber" class="confirmed">N/A</span></div>
		<div id="inputBox" class="col-xs-10 col-xs-offset-1"></div>
		<div class="col-xs-6 btn btn-outline btn-warning btn-lg btn-flex" style="margin-top: 10px; margin-bottom: 10px;" id="sendBtn">WYŚLIJ <span class="glyphicon glyphicon-send"></span></div>
		<div class="col-xs-6 btn btn-outline btn-success btn-lg btn-flex authorizeBtn" style="margin-top: 10px; margin-bottom: 10px;">AUTORYZUJ <span class="glyphicon glyphicon-lock"></span></div>
		<div class="row">
			<div class="col-xs-4 btn btn-default btn-lg sendable" value="1">1</div>
			<div class="col-xs-4 btn btn-default btn-lg sendable" value="2">2</div>
			<div class="col-xs-4 btn btn-default btn-lg sendable" value="3">3</div>
		</div>
		<div class="row">
			<div class="col-xs-4 btn btn-default btn-lg sendable" value="4">4</div>
			<div class="col-xs-4 btn btn-default btn-lg sendable" value="5">5</div>
			<div class="col-xs-4 btn btn-default btn-lg sendable" value="6">6</div>
		</div>
		<div class="row">
			<div class="col-xs-4 btn btn-default btn-lg sendable" value="7">7</div>
			<div class="col-xs-4 btn btn-default btn-lg sendable" value="8">8</div>
			<div class="col-xs-4 btn btn-default btn-lg sendable" value="9">9</div>
		</div>
		<div class="row">
			<div class="col-xs-4 btn btn-default btn-lg sendable" value="/">/</div>
			<div class="col-xs-4 btn btn-default btn-lg sendable" value="0">0</div>
			<div class="col-xs-4 btn btn-default btn-lg sendable" value=".">.</div>
		</div>
		<div class="row">
			<div class="col-xs-8 btn btn-default sendable" value="-">-</div>
			<div class="col-xs-4 btn btn-success btn-flex sendable" value="C"><b>C</b> <span class="glyphicon glyphicon-arrow-left"></span></div>
		</div>
		<br>
		<div class="alert alert-info">
			Korzystając z tej aplikacji akceptujesz politykę cookies
		</div>
	</div>

	<div id="mimicWrapper" class="col-xs-12 text-center hide">
		<div class="optionsFlex"><span class="userBtn glyphicon glyphicon-user"></span><span class="optionsBtn glyphicon glyphicon-cog"></span></div>
		<div><span id="confirmedYou" class="confirmed">N/A</span>, klasa: <span id="confirmedClass" class="confirmed">N/A</span>, numer: <span id="confirmedNumber" class="confirmed">N/A</span></div>
		<hr>
		<div class="col-xs-5 btn btn-outline btn-success btn-lg btn-block btn-flex authorizeBtn">AUTORYZUJ <span class="glyphicon glyphicon-lock"></span></div><br><br>
		<hr>
		<div id="mimicWaitingForData" class="hide">
			<h2>Czekam na dane . . .</h2>
			<img src="./animal.gif" style="pointer-events: none;">
		</div>
		<div id="mimicQuizBox" class="hide">
			<h3>Pytanie <span id="idPytania">N/A</span>:</h3>
			<div id="mimicQuizBoxQuestion" class="mimicQuizBoxBorder col-xs-12">N/A</div><br>
			<h3 style="margin-bottom: 25px; margin-top: 25px;">Odpowiedzi:</h3>
			<div id="mimicQuizBoxAnswer1" class="mimicQuizBoxAnswer mimicQuizBoxBorder col-xs-12">N/A</div><br>
			<div id="mimicQuizBoxAnswer2" class="mimicQuizBoxAnswer mimicQuizBoxBorder col-xs-12">N/A</div><br>
			<div id="mimicQuizBoxAnswer3" class="mimicQuizBoxAnswer mimicQuizBoxBorder col-xs-12">N/A</div><br>
			<div id="mimicQuizBoxAnswer4" class="mimicQuizBoxAnswer mimicQuizBoxBorder col-xs-12">N/A</div><br>
		</div>
		<div id="afterMimicResults" class="hide">
			<h2><span id="afterMimicResultsName"></span><span id="afterMimicResultsScore" style="color: greenyellow; font-size: 1.6em;"></span></h2>
		</div>
	</div>

	<div id="selfQuizWrapper" class="col-xs-12 text-center hide">
		<div class="optionsFlex"><span class="userBtn glyphicon glyphicon-user"></span><span class="optionsBtn glyphicon glyphicon-cog"></span></div>
		<div><span id="confirmedYou" class="confirmed">N/A</span>, klasa: <span id="confirmedClass" class="confirmed">N/A</span>, numer: <span id="confirmedNumber" class="confirmed">N/A</span></div>
		<hr>
		<div class="col-xs-5 btn btn-outline btn-success btn-lg btn-block btn-flex authorizeBtn">AUTORYZUJ <span class="glyphicon glyphicon-lock"></span></div><br><br>
		<hr>
		<h1>Hi!</h1>
	</div>

	<div id="userModal" class="modal fade" role="dialog">
	  <div class="modal-dialog">

		<div class="modal-content text-center">
		  <div class="modal-header">
			<button type="button" class="close" data-dismiss="modal">&times;</button>
			<h4 class="modal-title">TWOJE DANE</h4>
		  </div>
		  <div class="modal-body">
			Imię i nazwisko: <kbd id="kbdYou"></kbd><br>
			Klasa: <kbd id="kbdClass"></kbd><br>
			Numer: <kbd id="kbdNumber"></kbd><br>
			<hr>
			ID urządzenia: <kbd id="kbdDeviceId"></kbd><br>
			Adres IP: <kbd id="kbdIP"></kbd><br>
			Oprogramowanie: <kbd id="kbdSoftware"></kbd>
		  </div>
		</div>

	  </div>
	</div>

	<div id="optionsModal" class="modal fade" role="dialog">
	  <div class="modal-dialog">

		<div class="modal-content text-center">
		  <div class="modal-header">
			<button type="button" class="close declineDeletingCookies" data-dismiss="modal">&times;</button>
			<h4 class="modal-title">USTAWIENIA</h4>
		  </div>
		  <div class="modal-body">
			<div id="upperSettings">
				<div class="switchDivFlex">
					<span>Naśladuj aplikacje główną</span>
					<label class="switch">
						<input type="checkbox" class="settingsCheckbox" name="mimicMainApp">
						<div class="slider round" name="mimicMainApp"></div>
					</label>
				</div>
				<div class="switchDivFlex">
					<span>Tryb kartkówki</span>
					<label class="switch">
						<input type="checkbox" class="settingsCheckbox" name="selfQuizingMode">
						<div class="slider round" name="selfQuizingMode"></div>
					</label>
				</div>
			</div>
			<hr>
			<button id="reloadQuestionBtn" type="button" class="btn btn-warning btn-block btn-flex">RELOAD <span class="glyphicon glyphicon-refresh"></span></button>
			<button id="deleteCookiesBtn" type="button" class="btn btn-danger btn-block btn-flex">USUŃ CIASTKA <span class="glyphicon glyphicon-remove-circle"></span></button>
			<div id="deleteCookiesConfirmationBox" class="hide">
				<h3 style="margin-top: 10px;">Czy napewno chcesz usunąć ciastka?<br><small style="font-size: 0.7em;">Po usunięciu ciastek, aplikacja nie będzie działać prawidłowo do czasu ponownego ustawienia identyfikatora!</small></h3>
				<div class="row">
					<div class="col-xs-6">
						<button id="confirmDeletingCookies" type="button" class="btn btn-danger btn-block btn-flex">TAK <span class="glyphicon glyphicon-ok"></span></button>    
					</div>
					<div class="col-xs-6">
						<button id="declineDeletingCookies" type="button" class="btn btn-success btn-block btn-flex declineDeletingCookies">NIE <span class="glyphicon glyphicon-remove"></span></button>    
					</div>
				</div>
			</div>
		  </div>
		</div>

	  </div>
	</div>
</body>
</html>